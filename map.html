<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSMAIL map</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/carte.css">
</head>

<body>
    <div class="div_page">
        <div class="div_carte">
            <div class="div_piont">
                <!-- <div class="div_plane">
                    <div id="svg-plane"></div>
                </div> -->
            </div>
            <div id="svg-container">
            </div>
        </div>
        <div class="div_controls">

            <div class="div_zoom">
                <button id="zoom_in">+</button>
                <div class="div_zoom_out_bar">
                    <div class="div_zoom_in_bar"></div>
                </div>
                <button id="zoom_out">-</button>
                <button id="reset" onclick="reset_svg()">Reset</button>
            </div>
        </div>

        <div class="div_name_and_point">
            <div class="div_info">
                <div class="div_name">
                    <h2 id="nom_joueur"></h2>
                </div>
                <div class="div_point">
                    <h2>0</h2>
                </div>
            </div>

            <div class="div_nb_steep">
                <h3>nombre de pas :</h3>
                <h2>0</h2>
            </div>
        </div>

        <div class="div_all_cards"></div>
    </div>
</body>
<script src="js/cards.js"></script>
<script>

    // ouverture de la carte en svg
    fetch('./img/V1.svg')
        .then(response => response.text()) // Récupère le contenu du fichier SVG sous forme de texte
        .then(data => {
            document.getElementById('svg-container').innerHTML += data; // Injecte le SVG dans le DOM
            let layer8 = document.getElementById('Layer_8');
            // mise en place des evenements sur les villes
            for (let i = 0; i < layer8.children.length; i++) {
                let ville = layer8.children[i];
                ville.addEventListener('mouseover', function () {
                    city_hover(ville, 1);
                });
                ville.addEventListener('mouseout', function () {
                    city_hover(ville, 0);
                });
                ville.addEventListener('click', function () {
                    deplace_plane(ville);
                });
            }
            let villes_layer = document.getElementById('Layer_8');

            // rotation des villes en fonction de la carte
            for (let i = 0; i < villes_layer.children.length; i++) {
                let ville = villes_layer.children[i];
                let position_tmp = ville.querySelector('circle');
                if (position_tmp) {
                    let x = position_tmp.getAttribute('cx');
                    let y = position_tmp.getAttribute('cy');

                    ville.style.transformOrigin = `${x}px ${y}px`;
                    ville.style.transform = `rotate(${-angle}deg)`;
                    ville.style.transition = 'all 0.2s ease';
                }
            }

            // chargement de l'avion
            function add_plane(id, id_pawn, etat, type_pawn_name, id_emplacement_link) {
                fetch('./img/plane.svg')
                    .then(response => response.text()) // Récupère le contenu du fichier SVG sous forme de texte
                    .then(data => {
                        let div_plane = document.createElement('div');
                        div_plane.classList.add('div_plane');
                        div_plane.id = "plane-" + id;
                        div_plane.setAttribute('id_pawn', id_pawn);
                        div_plane.setAttribute('etat', etat);
                        div_plane.setAttribute('type_pawn_name', type_pawn_name);

                        let svg_plane = document.createElement('div');
                        svg_plane.classList.add('svg-plane');
                        svg_plane.innerHTML = data;
                        div_plane.appendChild(svg_plane);
                        document.getElementsByClassName('div_piont')[0].appendChild(div_plane);

                        div_plane.addEventListener('mousedown', function () {
                            id_pawn_selected = id;
                            plane_dragging = true;
                            click_down_plane = [event.clientX, event.clientY];
                        });

                        div_plane.addEventListener('click', function (event) {
                            id_pawn_selected = id;
                        });

                        document.addEventListener('mousemove', function (event) {
                            if (plane_dragging) {
                                move_plane(event);
                            }
                        });
                        set_starting_position(id_emplacement_link, id);
                    })
                    .catch(error => console.log(error));
            }



            fetch('./php/get_player_info.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ id_player: id_player})
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    for (let i = 0; i < data.length; i++) {
                        let player = data[i];
                        console.log(player);
                        document.getElementById('nom_joueur').innerText = player['nom'];
                        document.getElementsByClassName('div_point')[0].children[0].innerText = player['point'];
                        document.getElementsByClassName('div_nb_steep')[0].children[1].innerText = player['steep'];

                        add_plane(i, player['id_pawn'], player['etat'],player['type_pawn_name'],player['id_emplacement_link']);
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        })
        .catch(error => console.log(error));





    // set des variables
    let click_down = [0, 0]; // Position de la souris lors du clic
    let translates = [0, 0]; // Translation de la carte
    let dragging = false; // Indique si l'utilisateur est en train de faire glisser la carte
    let scale = 1; // Échelle de la carte   
    let angle = 0; // Angle de rotation de la carte

    let id_pawn_selected = 0; // Id du pion sélectionné
    let click_down_plane = [0, 0]; // Position de la souris lors du clic sur l'avion
    let translates_plane = [[0, 0], [0, 0], [0, 0]]; // Translation de l'avion
    let plane_dragging = false; // Indique si l'utilisateur est en train de faire glisser l'avion
        
    // deplacement de l'avion par le click
    function move_plane(event) {
        // Calculer le déplacement de la souris
        let x_move = (event.clientX - click_down_plane[0]) / scale;
        let y_move = (event.clientY - click_down_plane[1]) / scale;
        // Mettre à jour la variable de translation de l'avion
        translates_plane[id_pawn_selected][0] += x_move;
        translates_plane[id_pawn_selected][1] += y_move;
        // Mettre à jour la position de l'avion

        // selection de l'enfant avec le bon id
        document.querySelector('.div_piont').querySelector(`#plane-${id_pawn_selected}`).style.transform = `translate(${translates_plane[id_pawn_selected][0]}px, ${translates_plane[id_pawn_selected][1]}px)`;

        click_down_plane = [event.clientX, event.clientY];
    }
    // deplacement de l'avion

    function move_to(id_pawn,id_ville,adjustedX, adjustedY,id_emplacement) {

        console.log(id_pawn,id_ville,adjustedX, adjustedY,id_emplacement);

        translates_plane[id_pawn] = [adjustedX, adjustedY];
        document.querySelector('.div_piont').querySelector(`#plane-${id_pawn}`).style.transform = `translate(${adjustedX}px, ${adjustedY}px)`;
        document.querySelector('.div_piont').querySelector(`#plane-${id_pawn}`).setAttribute('data-ville', id_ville);

        let id_pawn_data = document.querySelector('.div_piont').querySelector(`#plane-${id_pawn}`).getAttribute('id_pawn');

        fetch('./php/update_pawn_position.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({ id_player: id_player, id_pawn: id_pawn_data, id_emplacement: id_emplacement })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                console.log(data);

            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });

    }
    
    function get_ville_position(ville){
        let position = ville.getBoundingClientRect();
        const svgContainer = document.getElementById('svg-container');
        const svgRect = svgContainer.getBoundingClientRect();
        let cityLeft = position.left - svgRect.left;
        let cityTop = position.top - svgRect.top - 15;
        let rotatedLeft = cityLeft * Math.cos(angle * Math.PI / 180) - cityTop * Math.sin(angle * Math.PI / 180);
        let rotatedTop = cityLeft * Math.sin(angle * Math.PI / 180) + cityTop * Math.cos(angle * Math.PI / 180);
        let adjustedX = (rotatedLeft) / scale;
        let adjustedY = (rotatedTop) / scale;

        return [adjustedX, adjustedY];
    }

    function deplace_plane(ville) {
        // Obtenir la position de la ville
        let param = get_ville_position(ville);

        let adjustedX = param[0];
        let adjustedY = param[1];
        
        // Vérifier si le joueur est autorisé à se déplacer vers la ville
        get_next_authorized_step(17).then(paths => {
            // Obtenir l'id reelle de la ville
            let id = ville.id;
            ville = id.split('-')[0];
            ville = ville.substring(3);
            ville = ville.replace('_', '');

            // si la ville n'a pas de connection
            if (paths.length == 0) {
                console.log('not authorized');
                console.log(ville);
                console.log(paths);
                return;
            }
            // si la ville est autorisé / son id est dans les paths
            if (paths.includes(ville)) {
                console.log('authorized');
                move_to(id_pawn_selected,ville,adjustedX, adjustedY,ville);
            }
            // si la ville n'est pas autorisé
            else {
                console.log('not authorized');
                console.log(ville);
                console.log(paths);
                return;
            }
        }).catch(error => {
            console.error('Error getting authorized steps:', error);
        });
    }
    // Fonction pour trouver les chemins possibles
    function findPaths(positions, startPosition, maxLength) {
        let next_steps = [];
        // Parcourt toutes les positions pour trouver les liens avec la position de départ
        positions.forEach(link => {
            if (link[1] == startPosition) {
                next_steps.push(link);
            }
            else if (link[2] == startPosition) {
                next_steps.push(link);
            }
        });
        let paths = [];
        // Parcourt les étapes suivantes pour trouver les chemins possibles
        next_steps.forEach(step => {
            if (maxLength - step[3] >= 0) {
                let sub_paths = findPaths(positions, step[2], maxLength - step[3]);

                if (step[1] == startPosition) {
                    paths.push(step[2]);
                }
                else {
                    paths.push(step[1]);
                }
            }
        });
        // Retourne les chemins possibles
        return paths;
    }

    // Fonction pour obtenir les étapes autorisées
    function get_next_authorized_step(nb_step) {
        // Obtenir la position actuelle de l'avion
        let plane = document.querySelector('.div_piont').querySelector(`#plane-${id_pawn_selected}`)
        // Obtenir l'id de la ville sur laquelle se trouve l'avion
        let ville = plane.getAttribute('data-ville');
        // Si l'avion n'est pas sur une ville
        if (ville == null) {
            return Promise.resolve([]); // Retourner une promesse résolue avec un tableau vide
        }
        // Obtenir l'id de la ville

        // verifier si l'id est sous forme de string ou de nombre
        console.log(ville);
        ville_tmp = parseInt(ville);
        if (isNaN(ville_tmp)) {
            ville = ville.split('-')[0];
            ville = ville.substring(3);
            ville = ville.replace('_', '');
            ville = parseInt(ville);
        }else{
            ville = ville_tmp;
        }
        // Obtenir les chemins possibles
        return fetch('./php/get_path.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({ position: ville })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                return findPaths(data, ville, nb_step); // Retourner le résultat après avoir trouvé les chemins = paths
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                return []; // Retourner un tableau vide en cas d'erreur
            });
    }

    // Fonction pour définir la position de départ de l'avion
    function set_starting_position(id_starting_position, pawn_id) {

        let start_id = String(id_starting_position);
        start_id = "_x3"+start_id[0]+"_"+start_id[1];


        let layer12 = document.getElementById('Layer_12');
        let ville = layer12.querySelector(`#${start_id}`);

        if (ville == null) {
            let layer8 = document.getElementById('Layer_8');
            start_id = start_id+"-2"
            ville = layer8.querySelector(`#${start_id}`);
        }

        let adjustedX;
        let adjustedY;

        let postions = get_ville_position(ville); 

        adjustedX = postions[0];
        adjustedY = postions[1];

        move_to(pawn_id,start_id,adjustedX, adjustedY,id_starting_position);
        


        for (let i = 0; i < layer12.children.length; i++) {
            let ville = layer12.children[i];
            let id = ville.getAttribute('id');
            if (id != start_id) {
                //rajout d'une class grisée
                ville.classList.add('grise');
            }
        }


    }

    function city_hover(city, etat) {
        if (etat == 0) {
            city.style.transform = 'scale(1)';
            city.style.filter = '';
            return;
        }
        else if (etat == 1) {
            city.style.transform = 'scale(1.1)';
            city.style.filter = 'drop-shadow(0px 5px 10px rgba(0, 0, 0, 0.35))';
        }
    }

    function mouve_svg(event) {
        if (!dragging) {
            return `translate(${translates[0]}px, ${translates[1]}px)`;
        }
        let x = event.clientX - click_down[0];
        let y = event.clientY - click_down[1];
        translates[0] += x;
        translates[1] += y;
        click_down = [event.clientX, event.clientY];
        return `translate(${translates[0]}px, ${translates[1]}px)`;
    }

    function zoom_svg(event) {
        event.preventDefault();  // Empêche le défilement par défaut
        let zoom = event.deltaY * -0.0005;  // Modifie la sensibilité
        scale += zoom * scale;

        if (scale > 6) {
            scale = 6;
        }
        if (scale < 0.5) {
            scale = 0.5;
        }
        return scale;
    }


    function reset_svg() {
        translates = [0, 0];
        scale = 1;
        angle = 0;  // Réinitialiser l'angle
        let svg_parent = document.getElementsByClassName('div_carte')[0];
        svg_parent.style.transform = `translate(${translates[0]}px, ${translates[1]}px) scale(${scale})`;
        let zoom_bar = document.getElementsByClassName('div_zoom_in_bar')[0];
        zoom_bar.style.height = '';
    }


    document.addEventListener('mouseup', function (event) {
        dragging = false;
        plane_dragging = false;
    });

    document.addEventListener('wheel', function (event) {
        event.preventDefault();
        let zoom = zoom_svg(event);
        scale = zoom;
        let move = mouve_svg(event);
        let svg_parent = document.getElementsByClassName('div_carte')[0];
        svg_parent.style.transition = 'transform 0.5s ease';
        svg_parent.style.transform = `${move} scale(${scale})`;
        let zoom_bar = document.getElementsByClassName('div_zoom_in_bar')[0];
        zoom_bar.style.height = `${100 / 6 * scale}%`;



    }, { passive: false });

    document.addEventListener('mousemove', function (event) {
        let svg_parent = document.getElementsByClassName('div_carte')[0];
        svg_parent.style.transition = 'transform 0.1s ease';
        svg_parent.style.transform = mouve_svg(event) + ` scale(${scale})`;
    });



    document.addEventListener('mousedown', function (event) {
        if (event.button !== 1) {
            return;
        }
        document.body.style.cursor = 'grabbing';
        dragging = true;
        click_down = [event.clientX, event.clientY];
    });

    document.addEventListener('mouseup', function () {
        document.body.style.cursor = '';
        dragging = false;
        dragging_plane = false;
    });

    // bnt zoom
    document.getElementById('zoom_in').addEventListener('click', function () {
        scale += 0.1 * scale;
        if (scale > 6) {
            scale = 6;
        }
        let svg_parent = document.getElementsByClassName('div_carte')[0];
        svg_parent.style.transform = `translate(${translates[0]}px, ${translates[1]}px) scale(${scale})`;
        let zoom_bar = document.getElementsByClassName('div_zoom_in_bar')[0];
        zoom_bar.style.height = `${100 / 6 * scale}%`;
    });

    document.getElementById('zoom_out').addEventListener('click', function () {
        scale -= 0.1 * scale;
        if (scale < 0.5) {
            scale = 0.5;
        }
        let svg_parent = document.getElementsByClassName('div_carte')[0];
        svg_parent.style.transform = `translate(${translates[0]}px, ${translates[1]}px) scale(${scale})`;
        let zoom_bar = document.getElementsByClassName('div_zoom_in_bar')[0];
        zoom_bar.style.height = `${100 / 3 * scale}%`;
    });




    // boucle d'update des pions toutes les 5 secondes

    setInterval(function () {
        
    }, 5000);


</script>

</html>
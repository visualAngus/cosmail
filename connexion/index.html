<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion</title>
    <link rel="stylesheet" href="../css/style_connexion.css">
</head>
<body>
    <header>
        <h1>COSMAIL</h1>
    </header>
    <main>
        <div class="left">
            <div class="content">
                <h2>Connexion</h2>
                <div class="input_div">
                    <label for="code">Code de la partie</label>
                    <input type="text" name="code" id="code" placeholder="Code" title="Entrez le code de 5 caractères de la partie">
                </div>
                <div class="input_div">
                    <label for="nom">Pseudo</label>
                    <input type="text" name="nom" id="nom" placeholder="Pseudo" title="Entrez votre pseudo">
                </div>
                <p id="error_txt"></p>
                <button id="connexion" onclick="get_info_partie()">Connexion</button>
            </div>
        </div>
        <div class="barre"></div>
        <div class="right">
            <div class="content">
                <h2>Creation d'une partie</h2>
                <div class="input_div">
                    <label for="code">Nombre de joueurs dans la partie</label>
                    <input type="number" name="nb_joueurs" id="nb_joueurs" placeholder="Nb" title="Entrez un nombre entre 2 et 6">
                    <script>
                        let nb_joueurs_input = document.getElementById("nb_joueurs");

                        nb_joueurs_input.addEventListener("input", function(event) {
                            if (nb_joueurs_input.value < 2) {
                                nb_joueurs_input.value = 2;
                            } else if (nb_joueurs_input.value > 6) {
                                nb_joueurs_input.value = 6;
                            }
                        });
                    </script>
                </div>
                <p id="error_txt"></p>
                <button id="create" onclick="create_partie()">Create</button>
            </div>
        </div>
    </main>
    <div class="chargement_div">
        <div class="div_txt">
            <h3>En attente des autres joueurs 0/0</h3>
        </div>
        <div class="div_chargement">
            <div class="dot-spinner">
                <div class="dot-spinner__dot"></div>
                <div class="dot-spinner__dot"></div>
                <div class="dot-spinner__dot"></div>
                <div class="dot-spinner__dot"></div>
                <div class="dot-spinner__dot"></div>
                <div class="dot-spinner__dot"></div>
                <div class="dot-spinner__dot"></div>
                <div class="dot-spinner__dot"></div>
            </div>
        </div>
    </div>
</body>
<script src="../js/distribute.js"></script>
<script>
    let error_txt = document.getElementById("error_txt");
    let code_input = document.getElementById("code");
    let btn = document.getElementById("connexion");
    let chargement_div = document.querySelector(".chargement_div");

    code_input.addEventListener("input", function(event) {
        // if more than 5 characters, stop typing
        if (code_input.value.length > 5) {
            // rendre impossible de taper plus de 5 caractères
            code_input.value = code_input.value.slice(0, 5);
        }

        });
    
        code_input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById("connexion").click();
            }
    });


    function get_info_partie() {
        let code = document.getElementById("code").value;
        code = code.toUpperCase();
        code = code.trim();

        let nom = document.getElementById("nom").value;
        nom = nom.trim();


        if (code.length != 5) {
            error_txt.textContent = "Le code doit contenir 5 caractères";
            error_txt.style.color = "red";

            setTimeout(function() {
                error_txt.textContent = "";
            }, 2000);

            return;
        }else if (nom.length < 2 ){
            error_txt.textContent = "Veuillez entrer un pseudo de plus 2 caractères";
            error_txt.style.color = "red";

            setTimeout(function() {
                error_txt.textContent = "";
            }, 2000);

            return;
        }


        return fetch('../php/get_partie_with_code.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({ code: code})
        })
            .then(response => response.json())
            .then(data => {
                if (data["error"]){
                    error_txt.textContent = "Code invalide";
                    error_txt.style.color = "red";
                }
                else{
                    let id = data[0]["id_partie"];
                    error_txt.textContent = "Code valide";
                    error_txt.style.color = "green";
                    code_input.disabled = true;
                    btn.disabled = true;
                    

                    fetch('../php/add_player.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({ id_partie: id, nom:nom})
                    })
                    .then(response => response.json())
                    .then(data => {;
                        console.log(data);

                        if (data["error"]){
                            error_txt.textContent = "Partie complète";
                            error_txt.style.color = "red";
                            return;
                        }
                        let nb_joueurs = data["nb_joueur"];
                        let nb_joueur_conn = data["nb_joueur_conn"];
                        let id_player = data["id_joueur"];
                        console.log(id_player);
                        
                        localStorage.setItem('id_partie', id);
                        localStorage.setItem('id_player', id_player);


                        let txt = "En attente des autres joueurs "+nb_joueur_conn+"/"+nb_joueurs;
                        document.querySelector(".div_txt").innerHTML = "<h3>"+txt+"</h3>";
                        
                        chargement_div.style.display = "flex";

                        setInterval(function() {
                            fetch('../php/get_player_status.php', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded'
                                },
                                body: new URLSearchParams({ id_partie: id })
                            })
                            .then(response => response.json())
                            .then(data => {
                                let nb_joueurs = data["nb_joueur"];
                                let nb_joueur_conn = data["nb_joueur_conn"];
                                let txt = "En attente des autres joueurs " + nb_joueur_conn + "/" + nb_joueurs;
                                document.querySelector(".div_txt").innerHTML = "<h3>" + txt + "</h3>";

                                if (nb_joueur_conn == nb_joueurs){
                                    distributeCards();

                                    setTimeout(function() {
                                        chargement_div.style.display = "none";
                                        window.location.href = "../map.html";
                                        return

                                    }, 2000);
                                }
                            })
                            .catch(error => console.error(error));
                        }, 1000);
                    })
                    .catch(error => console.error(error));
                    
                }

            })
            .catch(error => console.error(error));
    }
</script>
</html>